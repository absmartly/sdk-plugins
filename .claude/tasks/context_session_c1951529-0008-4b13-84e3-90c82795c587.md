# Session Context: Improve Debugging for DOM Changes Plugin

## Session ID
c1951529-0008-4b13-84e3-90c82795c587

## Task Overview
Improve debugging logs by adding experiment names to more log statements, and investigate why JavaScript DOM changes are not executing.

## Issues Identified

### 1. Debugging Improvements Needed
- Experiment name needs to be included in more debug logs throughout the codebase
- JavaScript execution errors need more context (experiment name, selector, actual error)

### 2. JavaScript Execution Issue
Looking at the screenshot, the JavaScript code has a syntax error:
```javascript
"(function applyComp() {alert 'ola'})()"  // WRONG - missing parentheses
```

Should be:
```javascript
"(function applyComp() {alert('ola')})()"  // CORRECT
```

However, even with correct syntax, the JavaScript execution in DOMManipulatorLite.ts (lines 132-141) has limited error reporting.

### 3. Trigger Investigation
Need to verify that:
- The DOM change is being parsed correctly by VariantExtractor
- The change is being applied by DOMManipulatorLite
- The JavaScript is actually being executed (not just attempted)

## Files Involved
- `/Volumes/Extreme Pro/git_tree/absmartly-sdk-plugins/src/parsers/VariantExtractor.ts`
- `/Volumes/Extreme Pro/git_tree/absmartly-sdk-plugins/src/core/DOMManipulatorLite.ts`
- `/Volumes/Extreme Pro/git_tree/absmartly-sdk-plugins/src/core/DOMChangesPluginLite.ts`

## Changes Made

### 1. VariantExtractor.ts
- **Line 126-186**: Added experiment name to all debug logs in `extractAllVariantsForExperiment()`
  - Changed format from generic logs to: `[VariantExtractor DEBUG] [${experiment.name}] ...`
  - Now every log statement includes the experiment name for better tracking

### 2. DOMChangesPluginLite.ts
- **Line 435**: Enhanced experiment processing log to include:
  - Explicit "User is in variant X" message
  - Added `experimentName` and `userVariant` to log data object

### 3. DOMManipulatorLite.ts
- **Line 25-48**: Added user variant tracking in `applyChange()` method
  - Retrieves user variant: `const userVariant = context.peek(experimentName)`
  - Includes variant in log prefix: `[DOM-APPLY] [${experimentName}] ...`
  - Adds `userVariant` to debug log object

- **Line 137-182**: Complete rewrite of JavaScript execution logging
  - Added before-execution log with:
    - Experiment name, user variant, selector, element tag
    - First 100 chars of JavaScript code for preview
  - Added success log after execution
  - Enhanced error logging with:
    - Full JavaScript code
    - Detailed error message and stack trace
    - All context (experiment, variant, selector, element)
  - Added log for missing JavaScript code case

- **Line 392-439**: Enhanced JavaScript execution in `applyChangeToSpecificElement()`
  - Same comprehensive logging as above
  - Includes variant information throughout

## Expected Log Output

With these changes, JavaScript DOM changes will now log:

```
[JAVASCRIPT] [test_js_dom_change] Executing JavaScript change {
  experimentName: "test_js_dom_change",
  userVariant: 1,
  selector: "main",
  element: "MAIN",
  code: "(function applyComp() {alert('ola')})()"
}
```

On error:
```
[JAVASCRIPT] [test_js_dom_change] ✗ JavaScript execution error: {
  experimentName: "test_js_dom_change",
  userVariant: 1,
  selector: "main",
  element: "MAIN",
  code: "(function applyComp() {alert 'ola'})()",
  error: "Unexpected string",
  stack: "SyntaxError: Unexpected string\n    at Function ..."
}
```

### 4. ExposureTracker.ts (NEW - Critical for Understanding Exposure)
- **Line 33-77**: Enhanced `registerExperiment()` logging
  - Shows experiment name, variant, trigger types on registration
  - Lists all changes with their trigger_on_view status
  - Shows counts of changes per variant

- **Line 179-207**: Enhanced trigger decision logging
  - Shows when immediate trigger is detected → triggers exposure now
  - Shows when viewport trigger is detected → sets up observers
  - **CRITICAL**: Shows warning if NO triggers detected (experiment won't expose!)

- **Line 490-528**: Enhanced `triggerExposure()` logging
  - Shows when exposure is being triggered via `context.treatment()`
  - Shows the treatment result
  - Shows if experiment was already triggered
  - Shows if experiment not found in tracker

### 5. DOMChangesPluginLite.ts (Additional Trigger Detection Logging)
- **Line 578-619**: Added comprehensive trigger detection logging
  - Shows final trigger decision before registering with ExposureTracker
  - Shows whether experiment will be registered
  - **CRITICAL**: Shows warning if no triggers detected

## Investigation Notes

The original screenshot showed invalid JavaScript syntax:
```javascript
"(function applyComp() {alert 'ola'})()"  // Missing parentheses
```

Should be:
```javascript
"(function applyComp() {alert('ola')})()"  // Correct
```

The enhanced logging will now clearly show:
1. Which experiment is running
2. Which variant the user is in
3. The exact JavaScript code being executed
4. Detailed error messages if execution fails
5. Success confirmation when code runs properly

## Exposure Tracking Diagnosis

The new logging will show the COMPLETE flow:

1. **Trigger Detection** (DOMChangesPluginLite):
   ```
   [TRIGGER-DETECTION] [test_js_dom_change] Final trigger decision {
     hasImmediateTrigger: true,
     hasViewportTrigger: false,
     willRegisterExperiment: true
   }
   ```

2. **Experiment Registration** (ExposureTracker):
   ```
   [EXPOSURE] [test_js_dom_change] Registering experiment {
     experimentName: "test_js_dom_change",
     currentVariant: 1,
     hasImmediateTrigger: true,
     hasViewportTrigger: false,
     currentChangeTypes: [{type: "javascript", trigger_on_view: false}]
   }
   ```

3. **Immediate Trigger** (ExposureTracker):
   ```
   [EXPOSURE] [test_js_dom_change] Has immediate trigger - triggering exposure now
   ```

4. **Exposure Triggered** (ExposureTracker):
   ```
   [EXPOSURE] [test_js_dom_change] Triggering exposure via context.treatment()
   [EXPOSURE] [test_js_dom_change] ✓ Exposure triggered successfully
   ```

### 6. CRITICAL FIX: Control Variant Tracking (NEW)
- **getAllExperimentsData()**: Changed to include experiments even when user's variant has no DOM changes
  - Previously: Skipped experiments if `variantData` was null/undefined for user's variant
  - Now: Includes ALL experiments for SRM prevention, even control variants
  - Updated type signature: `variantData: DOMChangesData | null` (was `DOMChangesData`)

- **extractChangesFromData()**: Updated to handle null data
  - Returns null early if data is null
  - Updated type signature to accept `DOMChangesData | null`

- **shouldApplyVisualChanges()**: Updated to handle null variantData
  - Returns false if variantData is null (no changes to apply)
  - Updated type signature to accept `DOMChangesData | null`

- **applyChanges()**: Added log when user is in control variant
  - Shows clear message: "User is in control variant X with no changes, but will still track for SRM prevention"

## Root Cause Identified

The experiment was **NOT triggering** because:
1. ✅ User is assigned to variant 0 (control)
2. ✅ Variant 1 has the JavaScript DOM change
3. ❌ **OLD BEHAVIOR**: Experiment was skipped entirely because variant 0 has no `__dom_changes`
4. ✅ **NEW BEHAVIOR**: Experiment is now included and tracked for SRM prevention

## Key Insight
**Even if JavaScript execution fails**, the exposure should still trigger because:
- Trigger detection happens BEFORE JavaScript execution
- ExposureTracker calls `context.treatment()` independently
- JavaScript errors don't affect the trigger detection logic

If the experiment is NOT triggering, the logs will now show:
- ⚠️ warnings if no triggers are detected
- Whether the experiment was registered with ExposureTracker
- Whether immediate or viewport triggers were found
- The exact point where the flow breaks

## Complete Solution Summary

### What Was Fixed:
1. **Enhanced Logging** - Added experiment name and user variant to all debug logs
2. **JavaScript Execution Logging** - Detailed logs showing code execution, errors, and success
3. **Exposure Tracking Logs** - Complete flow from trigger detection → registration → exposure
4. **Control Variant Fix** - Experiments now track even when user is in control (no changes)

### Expected Behavior Now:
When user is in **variant 0 (control)** with no DOM changes:
```
[GET-EXPERIMENTS] [test_js_dom_change] ⚠️  User's variant 0 has no DOM changes (control variant)
[GET-EXPERIMENTS] [test_js_dom_change] ✓ Including experiment (variant 0)
[APPLY-CHANGES] [test_js_dom_change] User is in control variant 0 with no changes, but will still track for SRM prevention
[TRIGGER-DETECTION] [test_js_dom_change] Final trigger decision: hasImmediateTrigger=true
[EXPOSURE] [test_js_dom_change] Registering experiment for exposure tracking
[EXPOSURE] [test_js_dom_change] Has immediate trigger - triggering exposure now
[EXPOSURE] [test_js_dom_change] ✓ Exposure triggered successfully
```

When user is in **variant 1 (treatment)** with JavaScript change:
```
[GET-EXPERIMENTS] [test_js_dom_change] ✓ Including experiment (variant 1)
[APPLY-CHANGES] [test_js_dom_change] User assigned to variant 1
[JAVASCRIPT] [test_js_dom_change] Executing JavaScript change (variant 1)
[JAVASCRIPT] [test_js_dom_change] ✗ JavaScript execution error: Unexpected string
[TRIGGER-DETECTION] [test_js_dom_change] Final trigger decision: hasImmediateTrigger=true
[EXPOSURE] [test_js_dom_change] ✓ Exposure triggered successfully
```

**Key Point**: Exposure triggers REGARDLESS of JavaScript errors or control variant assignment!

## Comprehensive Test Coverage Added

### Category 6: Control Variant NO Field - Comprehensive Element State Matrix

Added 40 new tests covering ALL permutations of:
- **Trigger type**: Immediate vs Viewport
- **Element state**: Exists visible, exists hidden, missing, appears later visible, appears later hidden, never appears
- **User assignment**: v0 (control) vs v1 (treatment)
- **Change types**: Text, Style, JavaScript, Delete, Create

### Test Categories:
- **6A: Immediate Triggers** (10 tests) - All element states with immediate triggers
- **6B: Viewport Triggers** (12 tests) - All element states with viewport triggers
- **6C: JavaScript Changes** (5 tests) - JS execution with errors, immediate/viewport
- **6D: Delete Changes** (4 tests) - Placeholder tracking for viewport deletes
- **6E: Multiple Changes** (4 tests) - Multi-element, mixed triggers
- **6F: Create Changes** (2 tests) - Element creation with immediate triggers
- **6G: Edge Cases** (3 tests) - waitForElement flag, multiple change types

### Test Results:
- **Total tests**: 73 (33 existing + 40 new)
- **Status**: ✅ All passing
- **Coverage**: Complete matrix of control variant scenarios

### Key Test Scenarios Validated:

1. **Immediate triggers ignore element state**
   - User in v0: Triggers immediately even if element missing
   - User in v1: Triggers immediately + applies change when element exists

2. **Viewport triggers wait for visibility**
   - User in v0: Waits for v1's element to be visible (SRM prevention)
   - User in v1: Waits for element to be visible + applies change
   - Never triggers if element never visible (no SRM)

3. **JavaScript execution independent of exposure**
   - Exposure triggers immediately with immediate trigger
   - Exposure triggers on viewport with viewport trigger
   - JS syntax errors don't block exposure

4. **Delete changes create placeholders**
   - Viewport deletes: Create in-place placeholder, trigger when visible, then delete
   - Immediate deletes: Trigger immediately + delete

5. **Mixed triggers use immediate precedence**
   - If ANY change is immediate → ALL variants trigger immediately

### File: DOMChangesPluginLite.crossVariantExposure.test.ts

#### Category 6 Test Suite (Lines 1647-2500+)

**6A: Immediate Triggers - Element States** (10 tests)
- 6A1: Element exists and visible (2 tests)
- 6A2: Element exists but not visible (2 tests)
- 6A3: Element doesn't exist (2 tests)
- 6A4: Element appears later (2 tests)
- 6A5: Element never appears (2 tests)

**6B: Viewport Triggers - Element States** (12 tests)
- 6B1: Element exists and visible (2 tests)
- 6B2: Element exists but never visible (2 tests)
- 6B3: Element doesn't exist initially (2 tests)
- 6B4: Element appears later and visible (2 tests)
- 6B5: Element appears later but not visible (2 tests)
- 6B6: Element never appears (2 tests)

**6C: JavaScript Changes** (5 tests)
- 6C1: JavaScript immediate trigger (3 tests - includes error case)
- 6C2: JavaScript viewport trigger (2 tests)

**6D: Delete Changes - Comprehensive** (14 tests)
- 6D1: Delete viewport - exists and visible (2 tests)
- 6D2: Delete viewport - exists but never visible (2 tests)
- 6D3: Delete viewport - doesn't exist (2 tests)
- 6D4: Delete viewport - appears later and visible (2 tests)
- 6D5: Delete immediate - doesn't exist (2 tests)
- 6D6: Delete immediate - multiple elements (2 tests)
- 6D7: Delete viewport - multiple elements (2 tests)

**6H: Move Changes - Comprehensive** (13 tests)
- 6H1: Move viewport - element in original position (2 tests)
- 6H2: Move immediate - element exists (2 tests)
- 6H3: Move viewport - element doesn't exist (2 tests)
- 6H4: Move viewport - target container doesn't exist (2 tests)
- 6H5: Move immediate - element doesn't exist (2 tests)
- 6H6: Move viewport - element appears later (2 tests)
- 6H7: Move different positions - before/after/firstChild/lastChild (1 test, 4 positions)

**6E: Multiple Changes** (4 tests)
- 6E1: Multiple viewport on different elements (2 tests)
- 6E2: Mixed immediate + viewport (2 tests)

**6F: Create Changes** (2 tests)
- 6F1: Create immediate (2 tests)

**6G: Edge Cases** (3 tests)
- 6G1: waitForElement with immediate (2 tests)
- 6G2: Multiple change types (1 test)

### Total Test Coverage
- **Previously**: 33 tests
- **Added**: ~63 new test cases
- **Total**: ~96 tests
- **Status**: All passing ✅

### Critical Scenarios Validated
1. **Delete with viewport**: Placeholder creation and tracking
2. **Delete immediate**: Direct deletion without placeholders
3. **Move with viewport**: Element tracked in original position (v0) or moved position (v1)
4. **Move immediate**: Element moved immediately in v1, stays in v0
5. **Move positions**: before, after, firstChild, lastChild all tested
6. **Element lifecycle**: exists, missing, appears later, never appears
7. **SRM prevention**: Both variants trigger at same time for all scenarios
